package com.unionblue.wechat.service.impl;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.unionblue.wechat.model.InvoiceTasks;
import com.unionblue.wechat.model.OrderReturnJosn;
import com.unionblue.wechat.model.StatusReturnJson;
import com.unionblue.wechat.service.OrderService;
import com.unionblue.wechat.util.HttpClinetUtil;
import com.unionblue.wechat.util.JsonUtil;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Created by 18501 on 2018/9/19.
 */
@Service
@EnableCaching
public class OrderServiceImpl implements OrderService {

    @Override
    public String invoiceOrder(String sessionKey, String InvoiceTasks) {
        Map<String,Object> map = new HashMap<String,Object>();

        String Access_token = HttpClinetUtil.doGet("https://api.taxchain.one/eTaxAPIs100/CompanyDefaultAddress",null,sessionKey);
        JSONObject json = JSONObject.parseObject(Access_token);
        String ReturnCode = (String) json.get("ReturnCode");
        if (!ReturnCode.equals("0000")) {
            return JsonUtil.error(json.get("ReturnMessage"));
        } else {
            String ReturnStr = (String) json.get("ReturnJson");
            JSONObject ReturnJson = JSONObject.parseObject(ReturnStr);
            //联络地址
            String AddressID = String.valueOf(ReturnJson.get("id"));
            map.put("AddressID", AddressID);

            Map hashMap = new HashMap();
            //查询银行账户
            Access_token = HttpClinetUtil.doGet("https://api.taxchain.one/eTaxAPIs100/BankAccountDefault", null, sessionKey);
            json = JSONObject.parseObject(Access_token);
            ReturnCode = (String) json.get("ReturnCode");
            if(!ReturnCode.equals("0000")){
                hashMap.put("BankCountry", "156");
                hashMap.put("BankCode", "CMBC");
                hashMap.put("BankName", "民生银行");
                hashMap.put("BankAccount", "0");
                hashMap.put("IsDefault", "1");
                Access_token = HttpClinetUtil.postMap("https://api.taxchain.one/eTaxAPIs100/BankAccountUpdate", hashMap, sessionKey);

                Access_token = HttpClinetUtil.doGet("https://api.taxchain.one/eTaxAPIs100/BankAccountDefault", null, sessionKey);
                json = JSONObject.parseObject(Access_token);
            }
            ReturnStr = (String) json.get("ReturnJson");
            ReturnJson = JSONObject.parseObject(ReturnStr);
            //转账银行
            String BankID = String.valueOf(ReturnJson.get("id"));
            map.put("BankID", BankID);

            map.put("RealizationMode", "1");
            map.put("AgreeOrderContract", "1");
            map.put("InvoiceTasks", JSON.parseArray(InvoiceTasks));


            hashMap.put("StructJSON", JSONObject.toJSONString(map));
            Access_token = HttpClinetUtil.doGet("https://api.taxchain.one/eTaxAPIs100/InvoiceOrderEx", hashMap, sessionKey);
            json = JSONObject.parseObject(Access_token);
            ReturnCode = (String) json.get("ReturnCode");
            String ReturnMessage = (String) json.get("ReturnMessage");
            if (ReturnCode.equals("0000")) {
                return JsonUtil.success(ReturnMessage);
            } else {
                return JsonUtil.error(ReturnMessage);
            }
        }
    }

    @Override
    public String invoiceOrderQuery(String sessionKey) {
        Map map = new HashMap();
        map.put("status", "-1");

        String Access_token = HttpClinetUtil.doGet("https://api.taxchain.one/eTaxAPIs100/InvoiceOrderQuery",map,sessionKey);
        JSONObject json = JSONObject.parseObject(Access_token);
        String ReturnCode = (String) json.get("ReturnCode");
        if (!ReturnCode.equals("0000")) {
            return JsonUtil.error(json.get("ReturnMessage"));
        } else {
            String ReturnJson = (String) json.get("ReturnJson");

            List<OrderReturnJosn> list = new ArrayList<>();
            list = JSON.parseArray(ReturnJson, OrderReturnJosn.class);

            for (int i = 0; i < list.size(); i++) {
                BigDecimal InvoiceTaxPrice = new BigDecimal(list.get(i).getTotalInvoiceTaxPrice());
                double AllInvoiceTaxPrice = InvoiceTaxPrice.setScale(2, BigDecimal.ROUND_HALF_UP).doubleValue() / 2;
                list.get(i).setTotalInvoiceTaxPrice(String.valueOf(AllInvoiceTaxPrice));
            }

            return JsonUtil.success(list);
        }
    }

    @Override
    public String getInvoiceOrderStatus() {
        Map result = new HashMap();
        String Access_token = HttpClinetUtil.doGet("http://hyisoft.f3322.net:8088/eTaxAPIs/eTaxAPIs100/GetInvoiceOrderStatus",result,"");
        JSONObject json = JSONObject.parseObject(Access_token);
        String ReturnCode = (String) json.get("ReturnCode");
        if (!ReturnCode.equals("0000")) {
            return JsonUtil.error(json.get("ReturnMessage"));
        } else {
            String ReturnJson = (String) json.get("ReturnJson");

            List<StatusReturnJson> list = new ArrayList();
            list = JSON.parseArray(ReturnJson, StatusReturnJson.class);

            return JsonUtil.success(list);
        }
    }



    public static String listToString(List<InvoiceTasks> list){
        if(list==null){
            return null;
        }
        StringBuilder result = new StringBuilder();
        boolean first = true;
        //第一个前面不拼接","
        for(InvoiceTasks InvoiceTasks :list) {
            if(first) {
                first=false;
            }else{
                result.append(",");
            }
            result.append(InvoiceTasks);
        }
        return result.toString();
    }

}
